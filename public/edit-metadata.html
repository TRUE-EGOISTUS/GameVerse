<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
</head>
<body class="gradient-bg">
    <header>
        <div class="header-content">
            <h1 class="neon-text">‚úèÔ∏è –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ò–ì–†–´</h1>
            <nav>
                <a href="dashboard.html" class="btn neon-btn">‚Üê –ù–∞–∑–∞–¥</a>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <form id="editForm" class="glass-card" enctype="multipart/form-data">
            <h2 class="neon-subtitle">–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã</h2>
            
            <div class="input-group">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∏–≥—Ä—ã</label>
                <input type="text" id="title" name="title" class="neon-input" required>
            </div>

            <div class="input-group">
                <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea id="description" name="description" class="neon-textarea" rows="4" required></textarea>
            </div>

            <div class="input-group">
                <label>–ñ–∞–Ω—Ä</label>
                <select id="genre" name="genre" class="neon-select" required>
                    <option value="–ê—Ä–∫–∞–¥–∞">–ê—Ä–∫–∞–¥–∞</option>
                    <option value="–ì–æ–ª–æ–≤–æ–ª–æ–º–∫–∞">–ì–æ–ª–æ–≤–æ–ª–æ–º–∫–∞</option>
                    <option value="–°—Ç—Ä–∞—Ç–µ–≥–∏—è">–°—Ç—Ä–∞—Ç–µ–≥–∏—è</option>
                </select>
            </div>

            <div class="input-group">
                <label>–û–±–ª–æ–∂–∫–∞ –∏–≥—Ä—ã</label>
                <input type="file" id="cover" name="cover" accept="image/*" class="neon-input">
                <img id="coverPreview" style="max-width: 200px; margin-top: 10px; display: none;">
            </div>

            <button type="submit" class="btn neon-btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
        </form>
    </main>

    <script>
        const gameId = new URLSearchParams(window.location.search).get('id');
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä—ã
        async function loadGameData() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');
                    window.location.href = '/login.html';
                    return;
                }

                const response = await fetch(`/games/${gameId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                
                const game = await response.json();
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
                document.getElementById('title').value = game.title || '';
                document.getElementById('description').value = game.description || '';
                document.getElementById('genre').value = game.genre || '–ê—Ä–∫–∞–¥–∞';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –æ–±–ª–æ–∂–∫—É
                if (game.cover) {
                    const preview = document.getElementById('coverPreview');
                    preview.src = game.cover;
                    preview.style.display = 'block';
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞:', err);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä—ã');
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        document.getElementById('editForm').onsubmit = async (e) => {
            e.preventDefault();
            
            try {
                const token = localStorage.getItem('token');
                if (!token) throw new Error('–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è');

                const formData = new FormData();
                formData.append('title', document.getElementById('title').value);
                formData.append('description', document.getElementById('description').value);
                formData.append('genre', document.getElementById('genre').value);

                // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –æ–±–ª–æ–∂–∫–∏, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –≤—ã–±—Ä–∞–Ω
                const coverFile = document.getElementById('cover').files[0];
                if (coverFile) {
                    formData.append('cover', coverFile);
                }

                const response = await fetch(`/games/${gameId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');

                const result = await response.json();
                if (result.success) {
                    alert('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!');
                    window.location.href = 'dashboard.html';
                } else {
                    throw new Error(result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                }
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞:', err);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π: ' + err.message);
            }
        };

        // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤—ã–±—Ä–∞–Ω–Ω–æ–π –æ–±–ª–æ–∂–∫–∏
        document.getElementById('cover').onchange = function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('coverPreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        };

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', loadGameData);
    </script>
</body>
</html>